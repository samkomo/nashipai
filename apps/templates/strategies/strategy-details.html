{% extends "layouts/base.html" %}

{% block title %} Project Detail {% endblock %} 

<!-- Element injected in the BODY element -->
{% block body_class %} sidebar-mini {% endblock body_class %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/static/assets/css/adminlte.min.css">

  <!-- Include Bootstrap CSS and jQuery if they are not already added -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <style>
    .floating-panel {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 300px;
        z-index: 1050;  /* Ensure it's above most other content */
    }
</style>

{% endblock stylesheets %}

{% block content %}  

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Strategy Detail</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">Marketplace</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
    <!-- {{strategy|tojson}} -->

      <!-- Default box -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-chart-line"></i> {{ strategy.strategy_name }}</h3>

          <div class="card-tools">
            <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
              <i class="fas fa-minus"></i>
            </button>
            <button type="button" class="btn btn-tool" data-card-widget="remove" title="Remove">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
            
          <div class="row">
            <div class="col-12 col-md-12 col-lg-9 order-2 order-md-1">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Equity Curve</h5>
            
                            <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <div class="btn-group">
                                <button type="button" class="btn btn-tool dropdown-toggle" data-toggle="dropdown">
                                <i class="fas fa-wrench"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-right" role="menu">
                                <a href="#" class="dropdown-item">Action</a>
                                <a href="#" class="dropdown-item">Another action</a>
                                <a href="#" class="dropdown-item">Something else here</a>
                                <a class="dropdown-divider"></a>
                                <a href="#" class="dropdown-item">Separated link</a>
                                </div>
                            </div>
                            <button type="button" class="btn btn-tool" data-card-widget="remove">
                                <i class="fas fa-times"></i>
                            </button>
                            </div>
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body" style="padding: 0; margin: 0;">
                            <div class="row m-0">
                                <div class="col-md-12 p-0">
                                    <img src="/static/assets/img/ZLMACD.png" alt="Strategy Chart" class="img-fluid" style="display: block; width: 100%; height: auto; margin: 0;">
                                </div>
                            </div>
                            <!-- /.row -->
                        </div>

                        <!-- ./card-body -->
                        <div class="card-footer">
                            <div class="row">
                                <!-- Net Profit -->
                                <div class="col-sm-3 col-6">
                                    <div class="description-block border-right">
                                        <span class="description-percentage text-success"><i class="fas fa-caret-up"></i> {{ strategy.performance_metrics.metrics.net_profit_percent_all }}%</span>
                                        <h5 class="description-header">${{ strategy.performance_metrics.metrics.net_profit_all | round(2) }}</h5>
                                        <span class="description-text">NET PROFIT</span>
                                    </div>
                                </div>
                                <!-- Total Trades -->
                                <div class="col-sm-3 col-6">
                                    <div class="description-block border-right">
                                        <span class="description-percentage text-info"><i class="fas fa-exchange-alt"></i></span>
                                        <h5 class="description-header">{{ strategy.performance_metrics.metrics.total_closed_trades_all }}</h5>
                                        <span class="description-text">TOTAL TRADES</span>
                                    </div>
                                </div>
                                <!-- Drawdown -->
                                <div class="col-sm-3 col-6">
                                    <div class="description-block border-right">
                                        <span class="description-percentage text-danger"><i class="fas fa-caret-down"></i> {{ strategy.performance_metrics.metrics.max_drawdown_percent }}%</span>
                                        <h5 class="description-header">${{ strategy.performance_metrics.metrics.max_drawdown | round(2) }}</h5>
                                        <span class="description-text">MAX DRAWDOWN</span>
                                    </div>
                                </div>
                                <!-- Profit Factor -->
                                <div class="col-sm-3 col-6">
                                    <div class="description-block">
                                        <span class="description-percentage text-success"><i class="fas fa-balance-scale-right"></i></span>
                                        <h5 class="description-header">{{ strategy.performance_metrics.metrics.profit_factor_all | round(2) }}</h5>
                                        <span class="description-text">PROFIT FACTOR</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- /.card-footer -->
                        </div>
                        <!-- /.card -->
                    </div>
                    <!-- /.col -->
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                              <h3 class="card-title">Performance Summary</h3>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body">
                              <table class="table m-0">
                                <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>All</th>
                                    <th>Long</th>
                                    <th>Short</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for key, value in strategy.performance_metrics.metrics.items() %}
                                {% if key.endswith('_all') and not key.endswith('_percent_all') %}
                                {% set measure = key[:-4] %}
                                {% set percent_key_all = measure + '_percent_all' %}
                                {% set percent_key_long = measure + '_percent_long' %}
                                {% set percent_key_short = measure + '_percent_short' %}
                                <tr>
                                    <td>{{ measure.replace('_', ' ').title() }}</td>
                                    <td>
                                    {{ value }}
                                    {% if percent_key_all in strategy.performance_metrics.metrics %}
                                    <br>
                                    <small class="text-muted">{{ strategy.performance_metrics.metrics[percent_key_all] }}</small>
                                    {% endif %}
                                    </td>
                                    <td>
                                    {{ strategy.performance_metrics.metrics.get(measure + '_long', 'N/A') }}
                                    {% if percent_key_long in strategy.performance_metrics.metrics %}
                                    <br>
                                    <small class="text-muted">{{ strategy.performance_metrics.metrics[percent_key_long] }}</small>
                                    {% endif %}
                                    </td>
                                    <td>
                                    {{ strategy.performance_metrics.metrics.get(measure + '_short', 'N/A') }}
                                    {% if percent_key_short in strategy.performance_metrics.metrics %}
                                    <br>
                                    <small class="text-muted">{{ strategy.performance_metrics.metrics[percent_key_short] }}</small>
                                    {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                                </tbody>
                            </table>
                            </div>
                            <!-- /.card-body -->
                          </div>
                        
                        
                        
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-12 col-lg-3 order-1 order-md-2">
                <h3 class="text-primary"> Strategy Metadata</h3>
                <p class="text-muted">
                    {% if strategy.description %}
                        {{ strategy.description }}
                    {% else %}
                        No description provided.
                    {% endif %}
                </p>
                <br>
                <div class="text-muted">
                    <p class="text-sm">Coin Pair
                        <b class="d-block">{{ strategy.coin_pair }}</b>
                    </p>
                    <p class="text-sm">Time Frame
                        <b class="d-block">{{ strategy.time_frame }}</b>
                    </p>
                    <p class="text-sm">Strategy Status
                        <b class="d-block">{{ strategy.status }}</b>
                    </p>
                    <p class="text-sm">Created By
                        <b class="d-block">{{ strategy.developer_username }}</b>
                    </p>
                </div>
            
                <h5 class="mt-5 text-muted">Strategy Resources</h5>
                <ul class="list-unstyled">
                    {% if strategy.settings_file_path %}
                    <li>
                        <a href="{{ url_for('static', filename=strategy.settings_file_path) }}" class="btn-link text-secondary"><i class="far fa-fw fa-file-alt"></i> Strategy Settings</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
            
            
          </div>
        </div>
        <!-- /.card-body -->
      </div>
      <!-- /.card -->

        <!-- Modal -->
        <div id="subscribeModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Subscribe to Strategy</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form action="{{ url_for('strategies_blueprint.subscribe_strategy') }}" method="post">
                            <div class="modal-body">
                                <input type="hidden" id="strategyId" name="strategy_id">
                                <input type="hidden" name="next" value="strategies_blueprint.list_strategies">
                                <div class="form-group">
                                    <label for="subscriptionType">Subscription Type</label>
                                    <select class="form-control" id="subscriptionType" name="subscription_type">
                                        <option value="free">Free</option>
                                        <option value="monthly">Monthly - $10</option>
                                        <option value="yearly">Yearly - $100</option>
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Subscribe</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="tradingBotWizardModal" tabindex="-1" role="dialog" aria-labelledby="tradingBotWizardModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="tradingBotWizardModalLabel">Trading Bot Wizard</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    
                    <form id="createBotForm" action="{{ url_for('trading_blueprint.create_bot') }}" method="post">
                        <div class="modal-body">
                            <!-- Wizard Content -->
                            <div id="wizard-content">
                                <!-- Step 1: Bot Details -->
                                <div id="step-1" class="wizard-step">
                                    <h4>Step 1: Bot Details</h4>
                                    <div class="form-group">
                                        <label for="botName">Bot Name</label>
                                        <input type="text" class="form-control" id="botName" name="bot_name" placeholder="Enter bot name" value="{{ strategy.strategy_name }} - Bot" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="botDescription">Description</label>
                                        <textarea class="form-control" id="botDescription" name="details" rows="2" placeholder="Enter description"></textarea>
                                    </div>
                                    <input type="hidden" name="strategy_id" id="strategyId" value="{{ strategy.id }}">
                                    <input type="hidden" name="user_id" value="{{ current_user.id }}">
                                </div>
                                
                                <!-- Step 2: Exchange Linking -->
                                <div id="step-2" class="wizard-step" style="display: none;">
                                    <h4>Step 2: Link Exchange and Account</h4>
                                    <div class="form-group">
                                        <label for="exchangeSelect">Select Account</label>
                                        <select class="form-control" id="exchangeSelect" name="exchange_account_id" required>
                                            <option selected disabled>Select Exchange Account</option>
                                            <!-- Additional options will be dynamically loaded -->
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Step 3: Deployment Environment -->
                                <div id="step-3" class="wizard-step" style="display: none;">
                                    <h4>Step 3: Deployment Environment</h4>
                                    <div class="form-group">
                                        <label for="environmentSelect">Select Environment</label>
                                        <select class="form-control" id="environmentSelect" name="status" required>
                                            <option value="development">Development</option>
                                            <option value="staging">Staging</option>
                                            <option value="production">Production</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="previous-btn" style="display: none;">Previous</button>
                            <button type="button" class="btn btn-primary" id="next-btn">Next</button>
                            <button type="submit" class="btn btn-success" id="submit-btn" style="display: none;">Deploy Bot</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>



        <!-- Floating Panel -->
        <div class="card card-outline card-success" style="position: fixed; bottom: 70px; right: 20px; width: 300px; z-index: 1050;">
            <div class="card-header">
                <h3 class="card-title">Strategy Actions</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                </div>
            </div>
            <div class="card-body">
                {% if strategy.is_subscribed %}
                    {% if strategy.is_botified %}
                        <a href="{{ url_for('trading_blueprint.list_bots') }}" class="btn btn-success btn-block">
                            Manage Trading Bot
                        </a>
                    {% else %}
                        <button class="btn btn-success btn-block" data-toggle="modal" data-target="#tradingBotWizardModal">
                            Deploy Trading Bot
                        </button>
                    {% endif %}
                    <a href="#" class="btn btn-warning btn-block">Copy Trading</a>
                    <button class="btn btn-secondary btn-block unsubscribe-btn" data-strategy-id="{{ strategy.id }}" onclick="unsubscribeStrategy({{ strategy.id }});">
                        Unsubscribe
                    </button>
                {% else %}
                    <button class="btn btn-info btn-block subscribe-btn" data-strategy-id="{{ strategy.id }}" data-toggle="modal" data-target="#subscribeModal">
                        Subscribe
                    </button>
                {% endif %}
            </div>
            
        </div>

    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<!-- jQuery -->
<script src="/static/assets/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="/static/assets/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="/static/assets/js/demo.js"></script>
<!-- Include jQuery and Bootstrap JS -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
<!-- Wizard Script -->

  <script>
    $(document).ready(function() {
        // Handle subscribe button click
        $('.subscribe-btn').click(function() {
            var strategyId = $(this).data('strategy-id');
            subscribeStrategy(strategyId);
        });

        // Handle unsubscribe button click
        $('.unsubscribe-btn').click(function() {
            var strategyId = $(this).data('strategy-id');
            unsubscribeStrategy(strategyId);
        });
    });

    function subscribeStrategy(strategyId) {
        // Add AJAX call to subscribe to a strategy


        $('#subscribeModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget); // Button that triggered the modal
            var strategyId = button.data('strategy-id'); // Extract info from data-* attributes
            var modal = $(this);
            modal.find('.modal-body #strategyId').val(strategyId);
        });
    }

    function unsubscribeStrategy(strategyId) {
        // Add AJAX call to unsubscribe from a strategy
        $.ajax({
            type: 'POST',
            url: '/strategies/unsubscribe/' + strategyId,
            success: function(response) {
                // alert('Unsubscribed successfully!');
                location.reload(); // Reload the page to refresh data
            },
            error: function(xhr) {
                alert('Unsubscription failed! Error: ' + xhr.responseText);
            }
        });
    }
</script>
<!-- Wizard Navigation Script -->
<script>
        var currentStep = 1;
        
        function showStep(step) {
        $('.wizard-step').hide();
        $('#step-' + step).show();
        }
    
        function setButtonVisibility(step) {
        if(step === 1) {
            $('#previous-btn').hide();
            $('#submit-btn').hide();
            $('#next-btn').show();
        } else if(step === 3) {
            $('#previous-btn').show();
            $('#submit-btn').show();
            $('#next-btn').hide();
        } else {
            $('#previous-btn').show();
            $('#submit-btn').hide();
            $('#next-btn').show();
        }
        }
    
        $(document).ready(function() {
        // Initialize the wizard by showing the first step
        showStep(currentStep);
        setButtonVisibility(currentStep);
    
        // Previous button click
        $('#previous-btn').click(function() {
            if(currentStep > 1) {
            currentStep--;
            showStep(currentStep);
            setButtonVisibility(currentStep);
            }
        });
    
        // Next button click
        $('#next-btn').click(function() {
            if(currentStep < 3) {
            currentStep++;
            showStep(currentStep);
            setButtonVisibility(currentStep);
            }
        });
    
       // When the form is submitted
        $('#createBotForm').submit(function(event) {
            event.preventDefault();  // Prevent the default form submission
            var formData = $(this).serialize();  // Serialize the form data

            $.ajax({
                type: 'POST',
                url: $(this).attr('action'),
                data: formData,
                success: function(response) {
                    // alert('Trading bot created successfully!');
                    // $('#tradingBotWizardModal').modal('hide');  // Hide the modal
                    window.location.reload();  // Optionally reload the page or redirect
                },
                error: function(response) {
                    alert('Failed to create the trading bot. Please check the details and try again.');
                },
                complete: function() {
                    $('#tradingBotWizardModal').modal('hide'); // Hide the modal after AJAX call completes
                }
            });
        });
        
    });
  </script>
  
  <script>
    $(document).ready(function() {
        var accountsData = {};  // Object to store account data by account ID
    
        // Load exchange accounts when the modal is shown
        $('#tradingBotWizardModal').on('show.bs.modal', function() {
            $.getJSON('/get-accounts', function(response, status) {
                if(status === 'success') {
                    var exchangeSelect = $('#exchangeSelect');
                    exchangeSelect.empty(); // Clear existing options
                    exchangeSelect.append('<option selected disabled>Select Exchange Account</option>');  // Add placeholder at the top
                    response.forEach(function(account) {
                        exchangeSelect.append($('<option>', {
                            value: account.id,
                            text: account.account_name
                        }));
                        
                        accountsData[account.id] = account;  // Store account data
                    });
                } else {
                    // Handle error, maybe show an alert or message to the user
                    alert('Failed to load exchange accounts. Please try again later.');
                }
            }).fail(function() {
                alert('Failed to load exchange accounts. Please check your network connection.');
            });
        });
    
        // Event listener for account selection change
        $('#exchangeSelect').change(function() {
            var selectedAccountId = $(this).val();
            var selectedAccount = accountsData[selectedAccountId];
    
            // Update API Key and Secret Key fields
            if(selectedAccount) {
                $('#apiKey').val(selectedAccount.api_key);
                $('#apiSecret').val(selectedAccount.api_secret);
            } else {
                $('#apiKey').val('');
                $('#apiSecret').val('');
            }
        });
    });
    </script>
    
{% endblock javascripts %}
